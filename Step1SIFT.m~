%close all; 
clc; 
clear all;

%read in video file
videofile = '~/mai_project_media/test_script3.mp4';
%videofile = 'video_cutted.avi';
templatefile = '~/mai_project_media/cropped_template.jpg';
trinity_loc = '~/mai_project_media/trinity.jpg';
trinity = imread(trinity_loc);
trinity = rgb2gray(trinity);

%approx 30 page turns
videoObj = VideoReader(videofile); 
template = imread(templatefile);

%More loop iterations than frames so discard last second of video
numFrames = int16(videoObj.FrameRate * (videoObj.Duration -1)); 
fprintf('Total Number of Frames: %d \n', numFrames);

%sample a frame every 0.1 seconds
dist_between_frame_samples = floor((videoObj.FrameRate / 10)); 

min_match_thresh_page_turn = 5;

%init difference matrix between neightbour frames
sift_matches = zeros(2, floor(numFrames/dist_between_frame_samples)+1); 

frame = 1;
array_index = 1;
while hasFrame(videoObj)
   
    currFrame = readFrame(videoObj); 
    
    if rem(frame, dist_between_frame_samples) == 0

       currFrame = rgb2gray(currFrame);

       [num, locs, mean_position, relevant_matches, matches] = match(trinity, currFrame, false, 0.5);
       close all

       sift_matches(1, array_index) = frame;
       sift_matches(2, array_index) = length(matches); 
       array_index = array_index + 1;
   
    end
   
   frame = frame + 1;
   
   if ( rem(frame, 25) == 0) 
     clc;
     fprintf('.%d', frame);
   end
   if (rem(frame, 200) == 0)
     fprintf('\n');
   end
end

page_turned = false;
frames_to_extract = [];
candidate_frames = [];

for i=1:length(sift_matches(1, :))

    if sift_matches >= min_match_thresh_page_turn
        candidate_frames = [candidate_frames sift_matches(:, i)];
    else
        len = length(candidate_frames);
        max_matches = -1;
        for j=1:len
            if candidate_frames(2, len-j+1) > max_matches
                best_frame = candidate_frames();
            end
        end
            
    end

end

figure(1)
plot(sift_matches(1, :), sift_matches(2, :))
title('Timeline Of MSE of Frames')
xlabel('Frame')
ylabel('SIFT Matches')

examscripts = cell([],1);
